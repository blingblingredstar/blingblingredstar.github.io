<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Parallel vs. AsyncCourse Introductionyou don’t know JS Agenda Async Patterns Parallel vs. Async Callbacks Thunks Promises Generators/Coroutines Event Reactive(observables) CSP(channel-oriented concurr">
<meta name="keywords" content="JavaScript,FrontEndMasters,Asynchronous,Callbacks,Thunks,Promises,Generators,Observables,CSP">
<meta property="og:type" content="article">
<meta property="og:title" content="Rethinking Asynchronous JavaScript">
<meta property="og:url" content="http://yoursite.com/2019/07/09/Rethinking-Asynchronous-JavaScript/index.html">
<meta property="og:site_name" content="刘勇的博客">
<meta property="og:description" content="Parallel vs. AsyncCourse Introductionyou don’t know JS Agenda Async Patterns Parallel vs. Async Callbacks Thunks Promises Generators/Coroutines Event Reactive(observables) CSP(channel-oriented concurr">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-07-09T07:47:23.537Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rethinking Asynchronous JavaScript">
<meta name="twitter:description" content="Parallel vs. AsyncCourse Introductionyou don’t know JS Agenda Async Patterns Parallel vs. Async Callbacks Thunks Promises Generators/Coroutines Event Reactive(observables) CSP(channel-oriented concurr">






  <link rel="canonical" href="http://yoursite.com/2019/07/09/Rethinking-Asynchronous-JavaScript/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Rethinking Asynchronous JavaScript | 刘勇的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">刘勇的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/09/Rethinking-Asynchronous-JavaScript/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘勇">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://img.zcool.cn/community/04c6fd55fa1a4a000001b19c79e625.jpg@160w_160h_1c_1e_1o_100sh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘勇的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Rethinking Asynchronous JavaScript

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-09 15:43:04 / 修改时间：15:47:23" itemprop="dateCreated datePublished" datetime="2019-07-09T15:43:04+08:00">2019-07-09</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Parallel-vs-Async"><a href="#Parallel-vs-Async" class="headerlink" title="Parallel vs. Async"></a>Parallel vs. Async</h2><h3 id="Course-Introduction"><a href="#Course-Introduction" class="headerlink" title="Course Introduction"></a>Course Introduction</h3><p><a href="http://YouDontKnowJS.com" target="_blank" rel="noopener">you don’t know JS</a></p>
<h4 id="Agenda"><a href="#Agenda" class="headerlink" title="Agenda"></a>Agenda</h4><ul>
<li>Async Patterns<ul>
<li>Parallel vs. Async</li>
<li>Callbacks</li>
<li>Thunks</li>
<li>Promises</li>
<li>Generators/Coroutines</li>
<li>Event Reactive(observables)</li>
<li>CSP(channel-oriented concurrency)<a id="more"></a>
<h3 id="Single-Threaded-JavaScript"><a href="#Single-Threaded-JavaScript" class="headerlink" title="Single Threaded JavaScript"></a>Single Threaded JavaScript</h3></li>
</ul>
</li>
</ul>
<p>parallel(并行)既多线程同时协同工作，关键在于优化(optimization)</p>
<p>async(异步)是单线程的(single thread)</p>
<h3 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h3><p>虽然js是单线程，但是可以通过event loop来更改事件的执行顺序来模拟出异步状态，在用户看来就是并发的，尽管js仍是单线程的既同一时刻只执行一个事件。</p>
<p>Async is manage our concurrency</p>
<h2 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a>Callback</h2><h3 id="Callback-Hell"><a href="#Callback-Hell" class="headerlink" title="Callback Hell"></a>Callback Hell</h3><p>最简单的回调函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'callback'</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<p>Callbacks == Continuations</p>
<p>callback Hell:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'one'</span>)</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'two'</span>)</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'three'</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<p>以上就是通常所说的回调地狱，也叫回调金字塔。回调地狱不仅仅是因为套嵌和缩进所造成的阅读问题，例如以下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">one</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'one'</span>)</span><br><span class="line">  setTimeout(cb, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">two</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'two'</span>)</span><br><span class="line">  setTimeout(cb, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">three</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'three'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">one(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  two(three)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>尽管缩进问题和套嵌问题已经改善，但是可读性仍然没有质的提高。</p>
<h3 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h3><ol>
<li>This exercise calls for you to write some async flow-control code. To start off with, you’ll use callbacks only.<br>这个练习要求您编写一些异步流控制代码。首先，您将只使用回调。</li>
<li>Expected behavior:<br>期望的行为:<ul>
<li>Request all 3 files at the same time (in “parallel”).<br>同时请求所有3个文件(“并行”)。</li>
<li>Render them ASAP (don’t just blindly wait for all to finish loading)<br>尽快渲染(不要盲目等待加载完成)</li>
<li>BUT, render them in proper (obvious) order: “file1”, “file2”, “file3”.<br>但是，以适当的(明显的)顺序呈现它们:“file1”、“file2”、“file3”。</li>
<li>After all 3 are done, output “Complete!”.<br>完成所有3项后，输出“Complete!”</li>
</ul>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeAjax</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fake_responses = &#123;</span><br><span class="line">    file1: <span class="string">'The first text'</span>,</span><br><span class="line">    file2: <span class="string">'The middle text'</span>,</span><br><span class="line">    file3: <span class="string">'The last text'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> randomDelay = (<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1e4</span>) % <span class="number">8000</span>) + <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Requesting: '</span> + url)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cb(fake_responses[url])</span><br><span class="line">  &#125;, randomDelay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************</span></span><br><span class="line"><span class="comment">// The old-n-busted callback way</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  fakeAjax(file, <span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// what do we do here?</span></span><br><span class="line">    handleResponse(file, text)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params">fileName, contents</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(fileName <span class="keyword">in</span> response)) &#123;</span><br><span class="line">    response[fileName] = contents</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fileNames = [<span class="string">'file1'</span>, <span class="string">'file2'</span>, <span class="string">'file3'</span>]</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; fileNames.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> filename = fileNames[i]</span><br><span class="line">    <span class="keyword">if</span> (filename <span class="keyword">in</span> response) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> filename == <span class="string">'string'</span>) &#123;</span><br><span class="line">        output(response[filename])</span><br><span class="line">        response[filename] = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// request all files at once in "parallel"</span></span><br><span class="line">getFile(<span class="string">'file1'</span>)</span><br><span class="line">getFile(<span class="string">'file2'</span>)</span><br><span class="line">getFile(<span class="string">'file3'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Callback-Problems-Inversion-of-Control"><a href="#Callback-Problems-Inversion-of-Control" class="headerlink" title="Callback Problems: Inversion of Control"></a>Callback Problems: Inversion of Control</h3><p>在这里的inversion of control指的是在代码中同步的部分是由我们预期的时间执行，由我们自己控制的，但是回调部分中的代码是交由event loop执行，无法预估执行时间，由event loop控制执行的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tracCheckout(</span><br><span class="line">  purchaseInfo,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">finish</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    chargeCreditCard(purchaseInfo)</span><br><span class="line">    showThankYouPage</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>以上是一个用来追踪付款的函数，这里想象了一个场景，有一天顾客提出了一个问题：信用卡重复支付了5次。经过排查可以怀疑是回调函数重复执行了5次，但是回调无法追踪，也没有具体文档。这就引出了一个问题，既我们默认回调是可以信任的，没有任何问题的。但实际上，不同回调实现的算法不同，所以会有各种的Corner cases。回调会有以下一些信任问题：</p>
<ol>
<li>not too early</li>
<li>not too late</li>
<li>not too many times</li>
<li>not too few times</li>
<li>no lost context</li>
<li>no swallowed errors<br>……</li>
</ol>
<h3 id="Callback-Problems-Not-Reason-able"><a href="#Callback-Problems-Not-Reason-able" class="headerlink" title="Callback Problems: Not Reason-able"></a>Callback Problems: Not Reason-able</h3><p>一般人的大脑基本是单线程的，在同一时刻只能思考一件事，js引擎也是一样。</p>
<p>当我们大脑的思考模式与js引擎工作模式分离的时候，也就是bug开始产生的时候。</p>
<p>以下是大脑工作模式的伪代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">start task1:</span><br><span class="line">  <span class="keyword">do</span> some stuff</span><br><span class="line">  pause</span><br><span class="line"></span><br><span class="line">start task2:</span><br><span class="line">  <span class="keyword">do</span> some other stuff</span><br><span class="line">  pause</span><br><span class="line"></span><br><span class="line">resume task1:</span><br><span class="line">  <span class="keyword">do</span> more stuff</span><br><span class="line">  pause</span><br><span class="line"></span><br><span class="line">resume task2:</span><br><span class="line">  finish stuff</span><br><span class="line"></span><br><span class="line">resume task1:</span><br><span class="line">  finish stuff</span><br></pre></td></tr></table></figure>
<p>使用callback时，工作模式更像下面的伪代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">start task1:</span><br><span class="line">  <span class="keyword">do</span> some stuff</span><br><span class="line">  pause</span><br><span class="line"></span><br><span class="line">  resume task1:</span><br><span class="line">    <span class="keyword">do</span> more stuff</span><br><span class="line">    pause</span><br><span class="line"></span><br><span class="line">    resume task1:</span><br><span class="line">      finish stuff</span><br><span class="line"></span><br><span class="line">start task2:</span><br><span class="line">  <span class="keyword">do</span> some stuff</span><br><span class="line">  pause</span><br><span class="line"></span><br><span class="line">  resume task2:</span><br><span class="line">    <span class="keyword">do</span> more stuff</span><br><span class="line">    pause</span><br><span class="line"></span><br><span class="line">    resume task2:</span><br><span class="line">      finish stuff</span><br></pre></td></tr></table></figure>
<p>但我们需要一些函数执行完在执行里一个函数的情况可以称为Temporal Dependency，使用回调函数处理temporal dependency的话就要套嵌回调函数。但是很明显，我们的大脑并不适合这种工作模式，理解起来很困难。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'First half of my program'</span>)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Second half of my program'</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Non-Fixes"><a href="#Non-Fixes" class="headerlink" title="Non Fixes"></a>Non Fixes</h3><h4 id="Async-Patterns-separate-callbacks"><a href="#Async-Patterns-separate-callbacks" class="headerlink" title="Async Patterns: separate callbacks"></a>Async Patterns: separate callbacks</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trySomething</span>(<span class="params">ok, err</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> num = <span class="built_in">Math</span>.random()</span><br><span class="line">    <span class="keyword">if</span>(num &gt; <span class="number">.5</span>) ok(num)</span><br><span class="line">    <span class="keyword">else</span> err(num)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trySomething(</span><br><span class="line">  num =&gt; <span class="built_in">console</span>.log(<span class="string">`Success <span class="subst">$&#123;num&#125;</span>`</span>),</span><br><span class="line">  num =&gt; <span class="built_in">console</span>.log(<span class="string">`Sorry <span class="subst">$&#123;num&#125;</span>`</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="Async-Pattern-“error-first-style”"><a href="#Async-Pattern-“error-first-style”" class="headerlink" title="Async Pattern: “error-first style”"></a>Async Pattern: “error-first style”</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trySomething</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> num = <span class="built_in">Math</span>.random()</span><br><span class="line">    <span class="keyword">if</span>(num &gt; <span class="number">.5</span>) callback(<span class="literal">null</span>, num)</span><br><span class="line">    <span class="keyword">else</span> callback(<span class="string">'Too low!'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trySomething(</span><br><span class="line">  (err, num) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err)</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">console</span>.log(<span class="string">`Number <span class="subst">$&#123;num&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="Async-Pattern-nested-callback-tasks"><a href="#Async-Pattern-nested-callback-tasks" class="headerlink" title="Async Pattern: nested-callback tasks"></a>Async Pattern: nested-callback tasks</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123; callback(data) &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getData(<span class="number">10</span>, <span class="function"><span class="keyword">function</span>(<span class="params">num1</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> x = <span class="number">1</span> + num1</span><br><span class="line">  getData(<span class="number">30</span>, <span class="function"><span class="keyword">function</span>(<span class="params">num2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> y = <span class="number">1</span> + num2</span><br><span class="line">    getData(</span><br><span class="line">      <span class="string">`Meaning of life: <span class="subst">$&#123;x + y&#125;</span>`</span>,</span><br><span class="line">      answer =&gt; <span class="built_in">console</span>.log(answer)</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Thunks"><a href="#Thunks" class="headerlink" title="Thunks"></a>Thunks</h2><h3 id="Synchronous-and-Asynchronous-Thunks"><a href="#Synchronous-and-Asynchronous-Thunks" class="headerlink" title="Synchronous and Asynchronous Thunks"></a>Synchronous and Asynchronous Thunks</h3><p>Thunk is a function that has everything already that it needs to do to give you some value back.</p>
<p>This is a synchronous thunk:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> add(<span class="number">10</span>, <span class="number">15</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">thunk() <span class="comment">// 25</span></span><br></pre></td></tr></table></figure>
<p>This is asynchronous thunk, only need to pass the callback argument:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAsync</span>(<span class="params">x, y, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123; cb(x + y)&#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = <span class="function"><span class="params">cb</span> =&gt;</span> addAsync(<span class="number">10</span>, <span class="number">15</span>, cb)</span><br><span class="line"></span><br><span class="line">thunk(<span class="function"><span class="params">sum</span> =&gt;</span></span><br><span class="line">  sum <span class="comment">// 25</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>Time is most complex factor of state in your program, managing time is most complex factor of state in your program</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeThunk</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> args = [].slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    args.push(cb)</span><br><span class="line">    fn.apply(<span class="literal">null</span>, args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAsync</span>(<span class="params">x, y, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123; cb(x + y)&#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = makeThunk(addAsycn, <span class="number">10</span>, <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">thunk(<span class="function"><span class="params">sum</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(sum) <span class="comment">// 25</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="Async-Patterns-nested-thunk-tasks"><a href="#Async-Patterns-nested-thunk-tasks" class="headerlink" title="Async Patterns: nested-thunk tasks"></a>Async Patterns: nested-thunk tasks</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> get10 = makeThunk(getData, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">const</span> get30 = makeThunk(getData, <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">get10(<span class="function"><span class="params">num1</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> x = <span class="number">1</span> + num1</span><br><span class="line">  get30(<span class="function"><span class="params">num2</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> y = <span class="number">1</span> + num2</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getAnswer = makeThunk(getData,</span><br><span class="line">      <span class="string">`Meaning of life: <span class="subst">$&#123;x + y&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    getAnswer(<span class="function"><span class="params">answer</span> =&gt;</span></span><br><span class="line">      <span class="built_in">console</span>.log(answer) <span class="comment">// Meaning of life: 42</span></span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h3><ol>
<li><p>You’ll do the same thing as the previous exercise(s), but now you should use thunks.<br>您将做与前面的练习相同的事情，但是现在您应该使用thunks。</p>
</li>
<li><p>Expected behavior:<br>期望的行为:</p>
<ul>
<li>Request all 3 files at the same time (in “parallel”).<br>同时请求所有3个文件(“并行”)。</li>
<li>Render them ASAP (don’t just blindly wait for all to finish loading)<br>尽快渲染(不要盲目等待加载完成)</li>
<li>BUT, render them in proper (obvious) order: “file1”, “file2”, “file3”.<br>但是，以适当的(明显的)顺序呈现它们:“file1”、“file2”、“file3”。</li>
<li>After all 3 are done, output “Complete!”.<br>完成所有3项后，输出“Complete!”</li>
</ul>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; callbackify &#125; <span class="keyword">from</span> <span class="string">'util'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeAjax</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fake_responses = &#123;</span><br><span class="line">    file1: <span class="string">'The first text'</span>,</span><br><span class="line">    file2: <span class="string">'The middle text'</span>,</span><br><span class="line">    file3: <span class="string">'The last text'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> randomDelay = (<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1e4</span>) % <span class="number">8000</span>) + <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Requesting: '</span> + url)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cb(fake_responses[url])</span><br><span class="line">  &#125;, randomDelay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// what do we do here?</span></span><br><span class="line">  <span class="keyword">let</span> text, fn <span class="comment">// 在函数内设置变量来保存异步函数返回的数据和回调函数</span></span><br><span class="line"></span><br><span class="line">  fakeAjax(file, response =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (fn) fn(response) <span class="comment">// 如果收到了闭包中的回调函数，使用回调函数处理数据</span></span><br><span class="line">    <span class="keyword">else</span> text = response <span class="comment">// 如果还没有收到回调函数，直接返回数据给闭包</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (text) callback(text) <span class="comment">// 如果异步请求执行完毕，已返回数据，直接使用回调函数处理数据</span></span><br><span class="line">    <span class="keyword">else</span> fn = callback <span class="comment">// 如果异步请求没有返回数据，将回调函数通过闭包传给异步请求，处理数据。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// request all files at once in "parallel"</span></span><br><span class="line"><span class="keyword">const</span> thunk1 = getFile(<span class="string">'file1'</span>),</span><br><span class="line">  thunk2 = getFile(<span class="string">'file2'</span>),</span><br><span class="line">  thunk3 = getFile(<span class="string">'file3'</span>)</span><br><span class="line"></span><br><span class="line">thunk1(<span class="function"><span class="params">text1</span> =&gt;</span> &#123;</span><br><span class="line">  output(text1)</span><br><span class="line">  thunk2(<span class="function"><span class="params">text2</span> =&gt;</span> &#123;</span><br><span class="line">    output(text2)</span><br><span class="line">    thunk3(<span class="function"><span class="params">text3</span> =&gt;</span> &#123;</span><br><span class="line">      output(text3)</span><br><span class="line">      output(<span class="string">'Complete!'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Thunks-and-Closures"><a href="#Thunks-and-Closures" class="headerlink" title="Thunks and Closures"></a>Thunks and Closures</h3><p>Why should thunk be something that’s part of my arsenal of weapons that I used to take down asynchronous programming issure?</p>
<p>In the thunk pattern by using the closure to maintain the state of something. We eliminate time as a complecting factor of state.</p>
<p>在上面的代码中，我们在闭包中设置变量保存异步调用返回的数据和尚未传入的回调函数，通过判断数据的状态来决定是在回调中直接处理数据还是将回调函数传入异步函数中返回处理过后的数据。通过这种方法，我们解决了数据返回的时间问题，既可以确认通过thunk，传入一个回调函数，会返回一个处理后的结果，这也是promise的基本原理之一，也是promise如此革命性的愿意之一。</p>
<h2 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h2><h3 id="Native-Promises"><a href="#Native-Promises" class="headerlink" title="Native Promises"></a>Native Promises</h3><p>Promise就像去肯德基买汉堡，把钱交给收银员后并不会立即得到一个汉堡，而是一个订单号。拿着订单号去柜台可以在汉堡准备好之后领到汉堡。在拿到订单号之后，虽然并没有立即获得汉堡，但是可以将订单号视为汉堡进行处理，可以将汉堡自己吃掉也可以交给另一个人。</p>
<p>promise是一个包裹future value的容器。promise提供了一种可以忽略value的时间状态来composing的方法，所以在函数式编程的理论中，promise是一个monad。</p>
<p>在callback模式中，我们提供一个callback给异步方法，由异步方法决定何时调用回调函数。在promise中，我们调用promise，在promise执行结束后通知我们，由我们决定对执行结果进行怎样处理。promise也可以视为一个eventListener，在执行结束后会有一个“Completion Events”。</p>
<h3 id="Promis-API"><a href="#Promis-API" class="headerlink" title="Promis API"></a>Promis API</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finish</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  chargeCreditCard(purchaseInfo)</span><br><span class="line">  showThankYouPage()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  logStatsError(err)</span><br><span class="line">  finish()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> listener = trackCheckout(purchaseInfo)</span><br><span class="line"></span><br><span class="line">listener.on(<span class="string">'completion'</span>, finish)</span><br><span class="line">listener.on(<span class="string">'error'</span>, error)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trackCheckout</span>(<span class="params">info</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// attempt to track the checkout</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// if successful, call resolve()</span></span><br><span class="line">      <span class="comment">// otherwise, call reject(error)</span></span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finish</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  chargeCreditCard(purchaseInfo)</span><br><span class="line">  showThankYouPage()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  logStatsError(err)</span><br><span class="line">  finish()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise = trackCheckout(purchaseInfo)</span><br><span class="line"></span><br><span class="line">promise.then(</span><br><span class="line">  finish,</span><br><span class="line">  error</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>通过promise，我们确认将要返回一个future value，可以自行决定对其如何进行处理，我们把控制权从异步方法转移回了我们自己，既通过消灭时间状态来消灭inversion of control。</p>
<h4 id="Promise-Trust"><a href="#Promise-Trust" class="headerlink" title="Promise Trust"></a>Promise Trust</h4><ol>
<li>Only resloved once</li>
<li>Either success or error</li>
<li>Messages passed/kept</li>
<li>Exceptions becomes errors</li>
<li>Immutable once resloved</li>
</ol>
<h3 id="Promise-Flow-Control"><a href="#Promise-Flow-Control" class="headerlink" title="Promise Flow Control"></a>Promise Flow Control</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">doFirstThing</span><br><span class="line">  then doSecondThing</span><br><span class="line">  then doThirdThing</span><br><span class="line">  then complete</span><br><span class="line">or error</span><br></pre></td></tr></table></figure>
<p>通过Chainning Promises,我们可以使用promise来处理数据流。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">doFirstThing()</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> doSecondThing)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> doThirdThing)</span><br><span class="line">  .then(</span><br><span class="line">    complete,</span><br><span class="line">    error</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delay</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">reslove, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(resolve,num)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">delay(<span class="number">100</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> delay(<span class="number">50</span>))</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> delay(<span class="number">200</span>))</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'All done'</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      res(data)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> x</span><br><span class="line"></span><br><span class="line">getData(<span class="number">10</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">num1</span> =&gt;</span> &#123;</span><br><span class="line">    x = <span class="number">1</span> + num1</span><br><span class="line">    <span class="keyword">return</span> getData(<span class="number">30</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">num2</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> y = <span class="number">1</span> + num2</span><br><span class="line">    <span class="keyword">return</span> getData(<span class="string">`Meaning of life: <span class="subst">$&#123;x + y&#125;</span>`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">answer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(answer) <span class="comment">// Meaning of life: 42</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h3><ol>
<li><p>You’ll do the same thing as the previous exercise(s), but now you should use thunks.<br>您将做与前面的练习相同的事情，但是现在您应该使用thunks。</p>
</li>
<li><p>Expected behavior:<br>期望的行为:</p>
<ul>
<li>Request all 3 files at the same time (in “parallel”).<br>同时请求所有3个文件(“并行”)。</li>
<li>Render them ASAP (don’t just blindly wait for all to finish loading)<br>尽快渲染(不要盲目等待加载完成)</li>
<li>BUT, render them in proper (obvious) order: “file1”, “file2”, “file3”.<br>但是，以适当的(明显的)顺序呈现它们:“file1”、“file2”、“file3”。</li>
<li>After all 3 are done, output “Complete!”.<br>完成所有3项后，输出“Complete!”</li>
</ul>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeAjax</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fake_responses = &#123;</span><br><span class="line">    file1: <span class="string">'The first text'</span>,</span><br><span class="line">    file2: <span class="string">'The middle text'</span>,</span><br><span class="line">    file3: <span class="string">'The last text'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> randomDelay = (<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1e4</span>) % <span class="number">8000</span>) + <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Requesting: '</span> + url)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cb(fake_responses[url])</span><br><span class="line">  &#125;, randomDelay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// what do we do here?</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    fakeAjax(file, resolve)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// request all files at once in "parallel"</span></span><br><span class="line"><span class="keyword">const</span> promise1 = getFile(<span class="string">'file1'</span>),</span><br><span class="line">  promise2 = getFile(<span class="string">'file2'</span>),</span><br><span class="line">  promise3 = getFile(<span class="string">'file3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// promise1</span></span><br><span class="line"><span class="comment">//   .then(file1 =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     output(file1)</span></span><br><span class="line"><span class="comment">//     return promise2</span></span><br><span class="line"><span class="comment">//   &#125;)</span></span><br><span class="line"><span class="comment">//   .then(file2 =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     output(file2)</span></span><br><span class="line"><span class="comment">//     return promise2</span></span><br><span class="line"><span class="comment">//   &#125;)</span></span><br><span class="line"><span class="comment">//   .then(file3 =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     output(file3)</span></span><br><span class="line"><span class="comment">//     output('complete')</span></span><br><span class="line"><span class="comment">//   &#125;)</span></span><br><span class="line"></span><br><span class="line">promise1</span><br><span class="line">  .then(output)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> promise2)</span><br><span class="line">  .then(output)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> promise3)</span><br><span class="line">  .then(output)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> output(<span class="string">'complete'</span>))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeAjax</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fake_responses = &#123;</span><br><span class="line">    file1: <span class="string">'The first text'</span>,</span><br><span class="line">    file2: <span class="string">'The middle text'</span>,</span><br><span class="line">    file3: <span class="string">'The last text'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> randomDelay = (<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1e4</span>) % <span class="number">8000</span>) + <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Requesting: '</span> + url)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cb(fake_responses[url])</span><br><span class="line">  &#125;, randomDelay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************</span></span><br><span class="line"><span class="comment">// The old-n-busted callback way</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    fakeAjax(file, resolve)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Request all files at once in</span></span><br><span class="line"><span class="comment">// "parallel" via `getFile(..)`.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Render as each one finishes,</span></span><br><span class="line"><span class="comment">// but only once previous rendering</span></span><br><span class="line"><span class="comment">// is done.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> files = [<span class="string">'file1'</span>, <span class="string">'file2'</span>, <span class="string">'file3'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parallel = files</span><br><span class="line">  .map(<span class="function"><span class="params">file</span> =&gt;</span> getFile(file))</span><br><span class="line">  .reduce(<span class="function">(<span class="params">chain, nextPromise</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> chain</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span> <span class="title">nextFile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextPromise</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(output)</span><br><span class="line">  &#125;, <span class="built_in">Promise</span>.resolve())</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> <span class="title">complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    output(<span class="string">'complete'</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Abstractions"><a href="#Abstractions" class="headerlink" title="Abstractions"></a>Abstractions</h3><h4 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all()"></a>Promise.all()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">  doTaks1a(),</span><br><span class="line">  doTaks1b(),</span><br><span class="line">  doTaks1c()</span><br><span class="line">])</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params">results</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> doTask2(</span><br><span class="line">      <span class="built_in">Math</span>.max(</span><br><span class="line">        results[<span class="number">0</span>],</span><br><span class="line">        results[<span class="number">1</span>],</span><br><span class="line">        results[<span class="number">2</span>]</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>Promise.all()将多个promise组合成的数组作为参数，参数中的promise状态更新后更新本身的状态。</p>
<h4 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race()"></a>Promise.race()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = trySomeAsyncThing()</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span></span><br><span class="line">  .race([</span><br><span class="line">    p,</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">_, reject</span>) </span>&#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        reject(<span class="string">'Timeout'</span>)</span><br><span class="line">      &#125;, <span class="number">3000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  ])</span><br><span class="line">  .then(</span><br><span class="line">    success,</span><br><span class="line">    error</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>Promise.race()将多个promise组合成的数组作为参数，并返回最先执行完毕的那个promise对象。</p>
<p><a href="https://github.com/getify/native-promise-only" target="_blank" rel="noopener">github.com/getify/native-promise-only</a></p>
<h3 id="Sequences-amp-Gates"><a href="#Sequences-amp-Gates" class="headerlink" title="Sequences &amp; Gates"></a>Sequences &amp; Gates</h3><p>sequence = automatically chained promises</p>
<p><a href="https://github.com/getify/asynquence" target="_blank" rel="noopener">Github Library Asynquence</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> delay1Second = <span class="function"><span class="params">done</span> =&gt;</span> &#123; setTimeout(done, <span class="number">1000</span>) &#125;</span><br><span class="line"></span><br><span class="line">ASQ()</span><br><span class="line">  .then(delay1Second)</span><br><span class="line">  .gate(</span><br><span class="line">    delay1Second,</span><br><span class="line">    delay1Second</span><br><span class="line">  )</span><br><span class="line">  .then(<span class="function"><span class="params">done</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2 seconds passed!'</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-5"><a href="#Exercise-5" class="headerlink" title="Exercise 5"></a>Exercise 5</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeAjax</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fake_responses = &#123;</span><br><span class="line">    file1: <span class="string">'The first text'</span>,</span><br><span class="line">    file2: <span class="string">'The middle text'</span>,</span><br><span class="line">    file3: <span class="string">'The last text'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> randomDelay = (<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1e4</span>) % <span class="number">8000</span>) + <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Requesting: '</span> + url)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cb(fake_responses[url])</span><br><span class="line">  &#125;, randomDelay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ASQ(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    fakeAjax(file, done)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Request all files at once in</span></span><br><span class="line"><span class="comment">// "parallel" via `getFile(..)`.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Render as each one finishes,</span></span><br><span class="line"><span class="comment">// but only once previous rendering</span></span><br><span class="line"><span class="comment">// is done.</span></span><br><span class="line">ASQ()</span><br><span class="line">  .seq(getFile(<span class="string">'file1'</span>))</span><br><span class="line">  .val(output)</span><br><span class="line">  .seq(getFile(<span class="string">'file2'</span>))</span><br><span class="line">  .val(output)</span><br><span class="line">  .seq(getFile(<span class="string">'file3'</span>))</span><br><span class="line">  .val(output)</span><br><span class="line">  .val(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    output(<span class="string">'Complete!'</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-6"><a href="#Exercise-6" class="headerlink" title="Exercise 6"></a>Exercise 6</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeAjax</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fake_responses = &#123;</span><br><span class="line">    file1: <span class="string">'The first text'</span>,</span><br><span class="line">    file2: <span class="string">'The middle text'</span>,</span><br><span class="line">    file3: <span class="string">'The last text'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> randomDelay = (<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1e4</span>) % <span class="number">8000</span>) + <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Requesting: '</span> + url)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cb(fake_responses[url])</span><br><span class="line">  &#125;, randomDelay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ASQ(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    fakeAjax(file, done)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Request all files at once in</span></span><br><span class="line"><span class="comment">// "parallel" via `getFile(..)`.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Render as each one finishes,</span></span><br><span class="line"><span class="comment">// but only once previous rendering</span></span><br><span class="line"><span class="comment">// is done.</span></span><br><span class="line"><span class="comment">// ASQ()</span></span><br><span class="line"><span class="comment">//   .seq.apply(</span></span><br><span class="line"><span class="comment">//     null,</span></span><br><span class="line"><span class="comment">//     ['file1', 'file2', 'file3']</span></span><br><span class="line"><span class="comment">//       // Request all files at once in "parallel"</span></span><br><span class="line"><span class="comment">//       .map(getFile)</span></span><br><span class="line"><span class="comment">//       // Render output as each file finishes, but</span></span><br><span class="line"><span class="comment">//       // only once previous rendering is done</span></span><br><span class="line"><span class="comment">//       .map(function(sq) &#123;</span></span><br><span class="line"><span class="comment">//         return function() &#123;</span></span><br><span class="line"><span class="comment">//           return sq.val(output)</span></span><br><span class="line"><span class="comment">//         &#125;</span></span><br><span class="line"><span class="comment">//       &#125;)</span></span><br><span class="line"><span class="comment">//   )</span></span><br><span class="line"><span class="comment">//   .val(function() &#123;</span></span><br><span class="line"><span class="comment">//     output('Complete!')</span></span><br><span class="line"><span class="comment">//   &#125;)</span></span><br><span class="line"></span><br><span class="line">ASQ()</span><br><span class="line">  .seq(...[<span class="string">'file1'</span>, <span class="string">'file2'</span>, <span class="string">'file3'</span>].map(getFile).map(<span class="function"><span class="params">seq</span> =&gt;</span> () =&gt; seq.val(output)))</span><br><span class="line">  .val(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    output(<span class="string">'Complete!'</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h2><h3 id="Generator-Example"><a href="#Generator-Example" class="headerlink" title="Generator Example"></a>Generator Example</h3><p>If promises were about solving the inversion of control issue in callback, generators are about solving the non-local, non-sequential reasonability problem.</p>
<p>A generator is a syntactic form of a state machine, is a pauseable function.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">gen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'hello'</span>)</span><br><span class="line">  <span class="keyword">yield</span> <span class="comment">// return and pause</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'world'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> it = gen()  <span class="comment">// return a iterator</span></span><br><span class="line">it.next() <span class="comment">// hello</span></span><br><span class="line">it.next() <span class="comment">// world</span></span><br></pre></td></tr></table></figure>
<h3 id="Messaging"><a href="#Messaging" class="headerlink" title="Messaging"></a>Messaging</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">  <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> iterator = main()</span><br><span class="line"></span><br><span class="line">iterator.next() <span class="comment">// &#123;value: 1, done: false&#125;</span></span><br><span class="line">iterator.next() <span class="comment">// &#123;value: 2, done: false&#125;</span></span><br><span class="line">iterator.next() <span class="comment">// &#123;value: 3, done: false&#125;</span></span><br><span class="line">iterator.next() <span class="comment">// &#123;value: undefined, done: true&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">coroutine</span>(<span class="params">generator</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> iterator = generator()</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iterator.next.apply(iterator, <span class="built_in">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> run = coroutine(<span class="function"><span class="keyword">function</span> *(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> x = <span class="number">1</span> + (<span class="keyword">yield</span>),</span><br><span class="line">    y = <span class="number">1</span> + (<span class="keyword">yield</span>)</span><br><span class="line">  <span class="keyword">yield</span> (x + y)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">run() <span class="comment">// &#123;value: undefined, done: false&#125;</span></span><br><span class="line">run(<span class="number">10</span>) <span class="comment">// &#123;value: undefined, done: false&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Meaning of life: <span class="subst">$&#123;run(<span class="number">30</span>).value&#125;</span>`</span>) <span class="comment">// Meaning of life: 42</span></span><br></pre></td></tr></table></figure>
<h3 id="Messaging-Quertions"><a href="#Messaging-Quertions" class="headerlink" title="Messaging Quertions"></a>Messaging Quertions</h3><p>generator can never finish. Sometimes you have to design a generator never finish.</p>
<p>可以在generator内部使用while(true)这个无限循环来实现生成unique ID之类的功能。</p>
<h3 id="Async-Generators"><a href="#Async-Generators" class="headerlink" title="Async Generators"></a>Async Generators</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">coroutine</span>(<span class="params">generator</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> iterator = generator()</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iterator.next.apply(iterator, <span class="built_in">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; run(data) &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> run = coroutine(<span class="function"><span class="keyword">function</span> *(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> x = <span class="number">1</span> + (<span class="keyword">yield</span> getData(<span class="number">10</span>))</span><br><span class="line">  <span class="keyword">const</span> y = <span class="number">1</span> + (<span class="keyword">yield</span> getData(<span class="number">30</span>))</span><br><span class="line">  <span class="keyword">const</span> answer = (<span class="keyword">yield</span> getData(</span><br><span class="line">    <span class="string">`Meaning of life: <span class="subst">$&#123;x + y&#125;</span>`</span></span><br><span class="line">  ))</span><br><span class="line">  <span class="built_in">console</span>.log(answer) <span class="comment">// Meaning of life: 42</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'This will be first?'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">run()</span><br></pre></td></tr></table></figure>
<p>通过使用generator，我们拥有了暂停函数执行的能力，这使得我们可以以同步的模式来编写异步代码，同时Error handler也可以以同步的方式来进行处理。</p>
<h3 id="Promises-Generator"><a href="#Promises-Generator" class="headerlink" title="Promises + Generator"></a>Promises + Generator</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ASQ(<span class="function"><span class="params">done</span> =&gt;</span> &#123; setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;done(data)&#125;, <span class="number">1000</span>)&#125; ) <span class="comment">// 返回一个新的promise对象，并设置好then方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ASQ()</span><br><span class="line">  .runner(<span class="function"><span class="keyword">function</span> *(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> x = <span class="number">1</span> + (<span class="keyword">yield</span> getData(<span class="number">10</span>))</span><br><span class="line">    <span class="keyword">const</span> y = <span class="number">1</span> + (<span class="keyword">yield</span> getData(<span class="number">30</span>))</span><br><span class="line">    <span class="keyword">const</span> answer = (<span class="keyword">yield</span> getData(</span><br><span class="line">      <span class="string">`Meaning of life: <span class="subst">$&#123;x + y&#125;</span>`</span></span><br><span class="line">    ))</span><br><span class="line">    <span class="keyword">yield</span> answer</span><br><span class="line">  &#125;)</span><br><span class="line">  .val(<span class="function"><span class="params">answer</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(answer)&#125;) <span class="comment">// Meaning of life: 42</span></span><br></pre></td></tr></table></figure>
<p>原生的promise和generator代码如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doWhenDataReecived</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  returnNextElement.next(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">createFlow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">yield</span> fetch(<span class="string">'http://twitter.com/will/tweets/1'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> returnNextElement = createFlow()</span><br><span class="line"><span class="keyword">const</span> futureData = returnNextElement.next()</span><br><span class="line"></span><br><span class="line">futureData.then(doWhenDataReceived)</span><br></pre></td></tr></table></figure>
<p>使用es6的async await语法，代码类似如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createFlow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Me first!'</span>)</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> fetch(<span class="string">'https://twitter.com/will/tweets/1'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createFlow()</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Me second!'</span>)</span><br></pre></td></tr></table></figure>
<p>因为目前promise是无法取消的，所以最新的async await语法也是无法取消的。但是使用generator和promise结合的语法是，可以直接使用generator.next来跳过promise执行。</p>
<h3 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeAjax</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fake_responses = &#123;</span><br><span class="line">    file1: <span class="string">'The first text'</span>,</span><br><span class="line">    file2: <span class="string">'The middle text'</span>,</span><br><span class="line">    file3: <span class="string">'The last text'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> randomDelay = (<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1e4</span>) % <span class="number">8000</span>) + <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Requesting: '</span> + url)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cb(fake_responses[url])</span><br><span class="line">  &#125;, randomDelay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ASQ(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    fakeAjax(file, done)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function getFile(file) &#123;</span></span><br><span class="line"><span class="comment">//   return new Promise(function(resolve)&#123;</span></span><br><span class="line"><span class="comment">//     fakeAjax(file,resolve);</span></span><br><span class="line"><span class="comment">//   &#125;);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">ASQ()</span><br><span class="line">  .runner(<span class="function"><span class="keyword">function</span>* <span class="title">loadFiles</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Request all files at once in</span></span><br><span class="line">    <span class="comment">// "parallel" via `getFile(..)`.</span></span><br><span class="line">    <span class="keyword">var</span> p1 = getFile(<span class="string">'file1'</span>)</span><br><span class="line">    <span class="keyword">var</span> p2 = getFile(<span class="string">'file2'</span>)</span><br><span class="line">    <span class="keyword">var</span> p3 = getFile(<span class="string">'file3'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Render as each one finishes,</span></span><br><span class="line">    <span class="comment">// but only once previous rendering</span></span><br><span class="line">    <span class="comment">// is done.</span></span><br><span class="line">    output(<span class="keyword">yield</span> p1)</span><br><span class="line">    output(<span class="keyword">yield</span> p2)</span><br><span class="line">    output(<span class="keyword">yield</span> p3)</span><br><span class="line">  &#125;)</span><br><span class="line">  .val(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    output(<span class="string">'Complete!'</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Quiz"><a href="#Quiz" class="headerlink" title="Quiz"></a>Quiz</h3><ol>
<li>What is “callback hell”? Why do callbacks suffer from “inversion of control” and “unreasonability”?</li>
<li>What is a Promise? How does it solve inversion of control issues?</li>
<li>How do you pause a generator? How do you resume it?</li>
<li>How do we combine generators and promises for flow control?</li>
</ol>
<p><a href="https://davidwalsh.name/es6-generators" target="_blank" rel="noopener">davidwalsh.name/es6-generatros</a></p>
<h2 id="Observables"><a href="#Observables" class="headerlink" title="Observables"></a>Observables</h2><h3 id="Events-Promises"><a href="#Events-Promises" class="headerlink" title="Events + Promises"></a>Events + Promises</h3><p>Concurrency: Events (+ Promises)?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> <span class="title">executor</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">  $(<span class="string">'#btn'</span>).click(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> className = event.target.className</span><br><span class="line">    <span class="keyword">if</span>(<span class="regexp">/foobar/</span>.test(className)) &#123;</span><br><span class="line">      resolve(className)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      reject()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p1.then(<span class="function"><span class="params">className</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(className)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>以上代码的功能为点击按钮，测试按钮的className是否符合正则，然后输出className,因为使用了promise，所以以上代码只能执行一次。所以我们可以改为如下，以多次运行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#btn'</span>).click(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> className = event.target.className,</span><br><span class="line">    p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> <span class="title">executor</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="regexp">/foobar/</span>.test(className)) &#123;</span><br><span class="line">        resolve(className)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        reject()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  </span><br><span class="line">  p1.then(<span class="function"><span class="params">className</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(className)&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>但是以上代码又变的没有什么意义，我们创建了一个promise后又在函数内直接使用了.then方法消费了promise。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#btn'</span>).click(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  [event]</span><br><span class="line">    .map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.className)</span><br><span class="line">    .filter(<span class="function"><span class="params">className</span> =&gt;</span> /foobar/.test(className))</span><br><span class="line">    .forEach(<span class="function"><span class="params">className</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(className)&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>以上代码我们还是将consumer和producer耦合在了一起，我们需要一种模式将producer和consumer解耦。</p>
<h3 id="Enter-Observables"><a href="#Enter-Observables" class="headerlink" title="Enter Observables"></a>Enter Observables</h3><p>Observable在课程中主要指的是微软的rx.js。</p>
<p>Observable is kind of like a chain of calculated fields in a spreadsheet.</p>
<p>在Excel表格中，单元格可以依据其他单元格的数据进行计算的结果做为数据保存，这就像是一个数据流，当我们更改其中一个单元格数据时，其他单元格的数据也会重新进行计算并更改。</p>
<p>Observable是一个producer，产生数据流，经过一系列计算转换后由consumer进行使用。</p>
<p>An observable is an adapter hooked onto an event source, that produces a promise, every time a new event comes through.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observable = Rx.Observable.formEvent(btn, <span class="string">'click'</span>)</span><br><span class="line"></span><br><span class="line">observable</span><br><span class="line">  .map(<span class="function"><span class="params">clickEvent</span> =&gt;</span> clickEvent.target.className)</span><br><span class="line">  .filter(<span class="function"><span class="params">className</span> =&gt;</span> /foobar/.test(className))</span><br><span class="line">  .distinctUntilChanged()</span><br><span class="line">  .subscribe(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data[<span class="number">1</span>])</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>可以通过<a href="http://rxmarbles.com/" target="_blank" rel="noopener">rxmarbles.com</a>来观察rx.js的各种api的输出结果，理解操作符作用。</p>
<h3 id="Reactive-Sequences"><a href="#Reactive-Sequences" class="headerlink" title="Reactive Sequences"></a>Reactive Sequences</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromEvent</span>(<span class="params">element, eventType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ASQ.react(<span class="function"><span class="params">proceed</span> =&gt;</span> &#123;</span><br><span class="line">    $(element).bind(eventType, proceed)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rsq = fromEvent(btn, <span class="string">'click'</span>) <span class="comment">// aka: Observable</span></span><br><span class="line"></span><br><span class="line">rsq</span><br><span class="line">  .val(<span class="function"><span class="params">event</span> =&gt;</span> event.target.className)</span><br><span class="line">  .then((done, className) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="regexp">/foobar/</span>.test(className)) &#123;</span><br><span class="line">      done(className)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .val(<span class="function"><span class="params">calssName</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(className)&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromEvent</span>(<span class="params">el, eventType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> rsq = ASQ.react.of()</span><br><span class="line">  $(el).bind(eventType, rsq.push)</span><br><span class="line">  <span class="keyword">return</span> rsq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rsq1 = ASQ.react.of(),</span><br><span class="line"> rsq2 = ASQ.react.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">let</span> x = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  rsq1.push(x++)</span><br><span class="line">  rsq2.push(x++)</span><br><span class="line">&#125;, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">rsq1.val(<span class="function"><span class="params">v</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">`1:<span class="subst">$&#123;v&#125;</span>`</span>)&#125;) <span class="comment">// 1: 10...1: 12... 1:14</span></span><br><span class="line">rsq2.val(<span class="function"><span class="params">v</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">`2:<span class="subst">$&#123;v&#125;</span>`</span>)&#125;) <span class="comment">// 2: 1...2: 2... 2: 3... 2: 11... 2: 13...</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h3><ol>
<li><p>In this exercise, we’re going to practice with “reactive sequences” programming (aka “observables”) using asynquence.</p>
</li>
<li><p>Set up a reactive sequence for the stream of click events from the button. Hint: <code>ASQ.react.of()</code> and <code>rsq.push(..)</code></p>
</li>
<li><p>Set up another reactive sequence that samples the sequence stream from (2) once per second. In other words, if you click the button multiple times in a second, you only get one event message. Hint: <code>setInterval(..)</code></p>
</li>
<li><p>The sampled sequence should add a “clicked!” message to the list.</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> $btn = $(<span class="string">'#btn'</span>),</span><br><span class="line">    $list = $(<span class="string">'#list'</span>),</span><br><span class="line">    clicks = ASQ.react.of(),</span><br><span class="line">    msgs = ASQ.react.of(),</span><br><span class="line">    latest</span><br><span class="line"></span><br><span class="line">  $btn.click(<span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// push click event messages into stream</span></span><br><span class="line">    clicks.push(evt)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample clicks stream</span></span><br><span class="line">  setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (latest) &#123;</span><br><span class="line">      msgs.push(<span class="string">'clicked!'</span>)</span><br><span class="line">      latest = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// subscribe to click stream</span></span><br><span class="line">  clicks.val(<span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span><br><span class="line">    latest = evt</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// subscribe to sampled message stream</span></span><br><span class="line">  msgs.val(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    $list.append($(<span class="string">'&lt;div&gt;'</span> + msg + <span class="string">'&lt;/div&gt;'</span>))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h2><h3 id="Concurrency-Channels"><a href="#Concurrency-Channels" class="headerlink" title="Concurrency + Channels"></a>Concurrency + Channels</h3><p>Channel is kind of like a stream, kind of like a pipe.</p>
<p>Channel提供了consumer向producer发出信息的机制。</p>
<p>CSP: Communicating Sequential Processes</p>
<p>Conmunicating Sequential Processes is all about modeling your application with lots of tiny independent pieces that we call processes, and they get to a point where they say we need to coordinate.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> channel = chan()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">process1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> put(channel, <span class="string">'Hello'</span>)</span><br><span class="line">  <span class="keyword">const</span> msg = <span class="keyword">yield</span> take(channel)</span><br><span class="line">  <span class="built_in">console</span>.log(msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">process2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> greeting = <span class="keyword">yield</span> take(channel)</span><br><span class="line">  <span class="keyword">yield</span> put(channel, greeting + <span class="string">'World'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Done'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hello World</span></span><br><span class="line"><span class="comment">// Done</span></span><br></pre></td></tr></table></figure>
<h3 id="Blocking-Channels"><a href="#Blocking-Channels" class="headerlink" title="Blocking Channels"></a>Blocking Channels</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">csp.go(<span class="function"><span class="keyword">function</span> *(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> csp.put(ch, <span class="built_in">Math</span>.random())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">csp.go(<span class="function"><span class="keyword">function</span> *(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> csp.take( csp.timeout(<span class="number">500</span>) )</span><br><span class="line">    <span class="keyword">let</span> num = <span class="keyword">yield</span> csp.take(ch)</span><br><span class="line">    <span class="built_in">console</span>.log(num)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">csp.go(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> msg = <span class="keyword">yield</span> csp.alts(ch1, ch2, ch3)</span><br><span class="line">    <span class="built_in">console</span>.log(msg)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Event-Channels"><a href="#Event-Channels" class="headerlink" title="Event Channels"></a>Event Channels</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromEvent</span>(<span class="params">el, eventType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ch = csp.chan()</span><br><span class="line">  $(el).bind(eventType, event =&gt; &#123;</span><br><span class="line">    csp.putAsync(ch, event)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ch</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">csp.go(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ch = fromEvent(el, <span class="string">'mousemove'</span>)</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> evt = <span class="keyword">yield</span> csp.take(ch)</span><br><span class="line">    <span class="built_in">console</span>.log(</span><br><span class="line">      evt.clientX + <span class="string">'.'</span> + evt.clientY</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ASQ().runner(</span><br><span class="line">  ASQ.csp.go(<span class="function"><span class="keyword">function</span> *<span class="title">process1</span>(<span class="params">ch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> ASQ.csp.put(ch, <span class="string">'Hello'</span>)</span><br><span class="line">    <span class="keyword">const</span> msg = <span class="keyword">yield</span> ASQ.csp.take(ch)</span><br><span class="line">    <span class="built_in">console</span>.log(msg)</span><br><span class="line">  &#125;),</span><br><span class="line">  ASQ.csp.go(<span class="function"><span class="keyword">function</span> *<span class="title">process2</span>(<span class="params">ch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> greeting = <span class="keyword">yield</span> ASQ.csp.take(ch)</span><br><span class="line">    <span class="keyword">yield</span> ASQ.csp.put(ch, greeting + <span class="string">" World"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'done!'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line"><span class="comment">// Hello World</span></span><br><span class="line"><span class="comment">// done!</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> $btn = $(<span class="string">'#btn'</span>),</span><br><span class="line">    $list = $(<span class="string">'#list'</span>),</span><br><span class="line">    clicks = ASQ.csp.chan(),</span><br><span class="line">    msgs = ASQ.csp.chan(),</span><br><span class="line">    queuedClick</span><br><span class="line"></span><br><span class="line">  $btn.click(listenToClicks)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// run go-routines</span></span><br><span class="line">  ASQ().runner(ASQ.csp.go(sampleClicks), ASQ.csp.go(logClick))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// push click event messages into channel</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">listenToClicks</span>(<span class="params">evt</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!queuedClick) &#123;</span><br><span class="line">      queuedClick = ASQ.csp.putAsync(clicks, evt)</span><br><span class="line">      queuedClick.then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        queuedClick = <span class="literal">null</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample clicks channel</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>* <span class="title">sampleClicks</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">yield</span> ASQ.csp.take(ASQ.csp.timeout(<span class="number">1000</span>))</span><br><span class="line">      <span class="keyword">yield</span> ASQ.csp.take(clicks)</span><br><span class="line">      <span class="keyword">yield</span> ASQ.csp.put(msgs, <span class="string">'clicked!'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// subscribe to sampled message channel</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>* <span class="title">logClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> msg = <span class="keyword">yield</span> ASQ.csp.take(msgs)</span><br><span class="line">      $list.append($(<span class="string">'&lt;div&gt;'</span> + msg + <span class="string">'&lt;/div&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Recap"><a href="#Recap" class="headerlink" title="Recap"></a>Recap</h3><ol>
<li>Callbacks / Thunks</li>
<li>Promises</li>
<li>Generators</li>
<li>Observables</li>
<li>CSP go-routines</li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          
            <a href="/tags/FrontEndMasters/" rel="tag"># FrontEndMasters</a>
          
            <a href="/tags/Asynchronous/" rel="tag"># Asynchronous</a>
          
            <a href="/tags/Callbacks/" rel="tag"># Callbacks</a>
          
            <a href="/tags/Thunks/" rel="tag"># Thunks</a>
          
            <a href="/tags/Promises/" rel="tag"># Promises</a>
          
            <a href="/tags/Generators/" rel="tag"># Generators</a>
          
            <a href="/tags/Observables/" rel="tag"># Observables</a>
          
            <a href="/tags/CSP/" rel="tag"># CSP</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/06/Asynchornous-Programming-in-JavaScript-with-RX-js-Observables/" rel="next" title="Asynchornous Programming in JavaScript(with RX.js Observables)">
                <i class="fa fa-chevron-left"></i> Asynchornous Programming in JavaScript(with RX.js Observables)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/12/Hardcore-Functional-Programming-in-JavaScript/" rel="prev" title="Hardcore Functional Programming in JavaScript">
                Hardcore Functional Programming in JavaScript <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://img.zcool.cn/community/04c6fd55fa1a4a000001b19c79e625.jpg@160w_160h_1c_1e_1o_100sh.jpg" alt="刘勇">
            
              <p class="site-author-name" itemprop="name">刘勇</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">57</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">101</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/blingblingredstar" title="GitHub &rarr; https://github.com/blingblingredstar" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:564447023@qq.com" title="E-Mail &rarr; mailto:564447023@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Parallel-vs-Async"><span class="nav-number">1.</span> <span class="nav-text">Parallel vs. Async</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Course-Introduction"><span class="nav-number">1.1.</span> <span class="nav-text">Course Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Agenda"><span class="nav-number">1.1.1.</span> <span class="nav-text">Agenda</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Single-Threaded-JavaScript"><span class="nav-number">1.2.</span> <span class="nav-text">Single Threaded JavaScript</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Concurrency"><span class="nav-number">1.3.</span> <span class="nav-text">Concurrency</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Callback"><span class="nav-number">2.</span> <span class="nav-text">Callback</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Callback-Hell"><span class="nav-number">2.1.</span> <span class="nav-text">Callback Hell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-1"><span class="nav-number">2.2.</span> <span class="nav-text">Exercise 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Callback-Problems-Inversion-of-Control"><span class="nav-number">2.3.</span> <span class="nav-text">Callback Problems: Inversion of Control</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Callback-Problems-Not-Reason-able"><span class="nav-number">2.4.</span> <span class="nav-text">Callback Problems: Not Reason-able</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Non-Fixes"><span class="nav-number">2.5.</span> <span class="nav-text">Non Fixes</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Async-Patterns-separate-callbacks"><span class="nav-number">2.5.1.</span> <span class="nav-text">Async Patterns: separate callbacks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Async-Pattern-“error-first-style”"><span class="nav-number">2.5.2.</span> <span class="nav-text">Async Pattern: “error-first style”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Async-Pattern-nested-callback-tasks"><span class="nav-number">2.5.3.</span> <span class="nav-text">Async Pattern: nested-callback tasks</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thunks"><span class="nav-number">3.</span> <span class="nav-text">Thunks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Synchronous-and-Asynchronous-Thunks"><span class="nav-number">3.1.</span> <span class="nav-text">Synchronous and Asynchronous Thunks</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Async-Patterns-nested-thunk-tasks"><span class="nav-number">3.1.1.</span> <span class="nav-text">Async Patterns: nested-thunk tasks</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-2"><span class="nav-number">3.2.</span> <span class="nav-text">Exercise 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Thunks-and-Closures"><span class="nav-number">3.3.</span> <span class="nav-text">Thunks and Closures</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promises"><span class="nav-number">4.</span> <span class="nav-text">Promises</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native-Promises"><span class="nav-number">4.1.</span> <span class="nav-text">Native Promises</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Promis-API"><span class="nav-number">4.2.</span> <span class="nav-text">Promis API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-Trust"><span class="nav-number">4.2.1.</span> <span class="nav-text">Promise Trust</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Promise-Flow-Control"><span class="nav-number">4.3.</span> <span class="nav-text">Promise Flow Control</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3"><span class="nav-number">4.4.</span> <span class="nav-text">Exercise 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-4"><span class="nav-number">4.5.</span> <span class="nav-text">Exercise 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Abstractions"><span class="nav-number">4.6.</span> <span class="nav-text">Abstractions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-all"><span class="nav-number">4.6.1.</span> <span class="nav-text">Promise.all()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-race"><span class="nav-number">4.6.2.</span> <span class="nav-text">Promise.race()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sequences-amp-Gates"><span class="nav-number">4.7.</span> <span class="nav-text">Sequences &amp; Gates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-5"><span class="nav-number">4.8.</span> <span class="nav-text">Exercise 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-6"><span class="nav-number">4.9.</span> <span class="nav-text">Exercise 6</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Generator"><span class="nav-number">5.</span> <span class="nav-text">Generator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Generator-Example"><span class="nav-number">5.1.</span> <span class="nav-text">Generator Example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Messaging"><span class="nav-number">5.2.</span> <span class="nav-text">Messaging</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Messaging-Quertions"><span class="nav-number">5.3.</span> <span class="nav-text">Messaging Quertions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Async-Generators"><span class="nav-number">5.4.</span> <span class="nav-text">Async Generators</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Promises-Generator"><span class="nav-number">5.5.</span> <span class="nav-text">Promises + Generator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-7"><span class="nav-number">5.6.</span> <span class="nav-text">Exercise 7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Quiz"><span class="nav-number">5.7.</span> <span class="nav-text">Quiz</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Observables"><span class="nav-number">6.</span> <span class="nav-text">Observables</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Events-Promises"><span class="nav-number">6.1.</span> <span class="nav-text">Events + Promises</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Enter-Observables"><span class="nav-number">6.2.</span> <span class="nav-text">Enter Observables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reactive-Sequences"><span class="nav-number">6.3.</span> <span class="nav-text">Reactive Sequences</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-8"><span class="nav-number">6.4.</span> <span class="nav-text">Exercise 8</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSP"><span class="nav-number">7.</span> <span class="nav-text">CSP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Concurrency-Channels"><span class="nav-number">7.1.</span> <span class="nav-text">Concurrency + Channels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Blocking-Channels"><span class="nav-number">7.2.</span> <span class="nav-text">Blocking Channels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Event-Channels"><span class="nav-number">7.3.</span> <span class="nav-text">Event Channels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-9"><span class="nav-number">7.4.</span> <span class="nav-text">Exercise 9</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Recap"><span class="nav-number">7.5.</span> <span class="nav-text">Recap</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘勇</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
